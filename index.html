<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>澎湖永續觀光指標 — AHP 專家問卷</title>
  <style>
    :root{
      --bg:#f8f9fa;
      --fg:#1a1a1a;
      --muted:#666;
      --card:#ffffff;
      --line:#e0e0e0;
      --accent:#2563eb;
      --accent-light:#dbeafe;
      --success:#16a34a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif;
      font-size:18px;
      line-height:1.6;
      color:var(--fg);
      background:var(--bg);
    }
    header{
      padding:24px 20px;
      background:var(--card);
      border-bottom:2px solid var(--line);
      text-align:center;
    }
    h1{font-size:24px; margin:0 0 8px; font-weight:700;}
    header p{margin:0; color:var(--muted); font-size:16px;}
    main{max-width:800px; margin:0 auto; padding:20px; padding-bottom:160px;}
    
    /* Progress bar */
    .progress-container{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:var(--card);
      border-top:1px solid var(--line);
      padding:12px 20px 16px;
      z-index:100;
    }
    .progress-bar{
      height:10px;
      background:#e5e7eb;
      border-radius:99px;
      overflow:hidden;
      margin-bottom:10px;
    }
    .progress-fill{
      height:100%;
      background:var(--accent);
      border-radius:99px;
      transition:width 0.3s ease;
    }
    .progress-info{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:15px;
      color:var(--muted);
    }
    .progress-section{
      font-weight:600;
      color:var(--fg);
    }
    
    /* Nav buttons */
    .nav-buttons{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:12px;
    }
    .nav-btn{
      padding:12px 32px;
      font-size:17px;
      font-weight:600;
      border-radius:12px;
      cursor:pointer;
      border:2px solid var(--line);
      background:#fff;
      transition:all 0.2s;
    }
    .nav-btn:hover:not(:disabled){
      border-color:var(--accent);
      color:var(--accent);
    }
    .nav-btn:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    .nav-btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .nav-btn.primary:hover:not(:disabled){
      background:#1d4ed8;
    }
    
    /* Sections */
    .section{
      background:var(--card);
      border-radius:16px;
      padding:24px;
      margin:20px 0;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      display:none;
    }
    .section.active{display:block;}
    .section-header{
      font-size:20px;
      font-weight:700;
      color:var(--accent);
      margin:0 0 20px;
      padding-bottom:12px;
      border-bottom:2px solid var(--accent-light);
    }
    .section-desc{
      font-size:16px;
      color:var(--muted);
      margin-bottom:20px;
      line-height:1.5;
    }
    
    /* Form fields */
    label{display:block; font-size:16px; font-weight:500; margin:16px 0 8px;}
    input[type="text"], input[type="number"]{
      width:100%;
      padding:14px 16px;
      border:2px solid var(--line);
      border-radius:12px;
      font-size:18px;
      background:#fff;
    }
    input[type="text"]:focus, input[type="number"]:focus{
      outline:none;
      border-color:var(--accent);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 600px){
      .grid2{grid-template-columns: 1fr;}
    }
    
    /* Comparison pairs */
    .pair{
      background:#fafbfc;
      border:2px solid var(--line);
      border-radius:16px;
      padding:20px;
      margin:16px 0;
    }
    .pair-question{
      font-size:17px;
      font-weight:600;
      text-align:center;
      margin-bottom:16px;
      color:var(--fg);
    }
    .pair-options{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .pair-label{
      flex:1;
      font-size:15px;
      line-height:1.4;
      padding:8px;
      text-align:center;
    }
    .pair-label.left{text-align:right;}
    .pair-label.right{text-align:left;}
    
    /* Slider */
    .slider-wrap{
      flex:1.5;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    input[type="range"]{
      width:100%;
      height:32px;
      background:transparent;
      -webkit-appearance:none;
      appearance:none;
      cursor:pointer;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:10px;
      background:linear-gradient(to right, var(--accent) 0%, #e5e7eb 50%, var(--accent) 100%);
      border-radius:99px;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      margin-top:-11px;
      width:32px;
      height:32px;
      border-radius:50%;
      background:var(--accent);
      border:3px solid #fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    input[type="range"]::-moz-range-track{
      height:10px;
      background:linear-gradient(to right, var(--accent) 0%, #e5e7eb 50%, var(--accent) 100%);
      border-radius:99px;
    }
    input[type="range"]::-moz-range-thumb{
      width:32px;
      height:32px;
      border-radius:50%;
      background:var(--accent);
      border:3px solid #fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .slider-value{
      font-size:15px;
      color:var(--muted);
      margin-top:8px;
      text-align:center;
    }
    
    /* Submit */
    .submit-section{
      text-align:center;
      padding:20px;
    }
    .btn-submit{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:16px;
      padding:20px 48px;
      font-size:20px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(37,99,235,0.3);
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .btn-submit:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(37,99,235,0.4);
    }
    .btn-submit:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    .status{
      margin-top:16px;
      font-size:16px;
    }
    .status.ok{color:var(--success);}
    .status.warn{color:#dc2626;}
    
    /* Section counter */
    .section-counter{
      display:inline-block;
      background:var(--accent-light);
      color:var(--accent);
      padding:4px 12px;
      border-radius:20px;
      font-size:14px;
      font-weight:600;
      margin-bottom:12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>澎湖永續觀光指標 — AHP 專家問卷</h1>
    <p>請依您的專業判斷，評估各項目的相對優先性</p>
  </header>

  <main>
    <!-- 基本資料 -->
    <section class="section active" data-section="0">
      <h2 class="section-header">基本資料（選填）</h2>
      <div class="grid2">
        <div>
          <label>姓名（可匿名）</label>
          <input id="name" type="text" autocomplete="name" />
        </div>
        <div>
          <label>單位／職稱</label>
          <input id="org" type="text" />
        </div>
        <div>
          <label>專長領域</label>
          <input id="field" type="text" />
        </div>
        <div>
          <label>相關年資（年）</label>
          <input id="years" type="number" min="0" step="1" />
        </div>
      </div>
    </section>

    <!-- 構面比較 -->
    <section class="section" data-section="1">
      <span class="section-counter">第 1 部分，共 5 部分</span>
      <h2 class="section-header">四大構面優先性比較</h2>
      <p class="section-desc">請比較四大構面的優先程度：永續管理、社會經濟永續、文化永續、環境永續</p>
      <div id="pairs-dimensions"></div>
    </section>

    <!-- A 永續管理 -->
    <section class="section" data-section="2">
      <span class="section-counter">第 2 部分，共 5 部分</span>
      <h2 class="section-header">永續管理（A）指標比較</h2>
      <p class="section-desc">共 14 項指標，請兩兩比較其優先程度</p>
      <div id="pairs-A"></div>
    </section>

    <!-- B 社會經濟永續 -->
    <section class="section" data-section="3">
      <span class="section-counter">第 3 部分，共 5 部分</span>
      <h2 class="section-header">社會經濟永續（B）指標比較</h2>
      <p class="section-desc">共 11 項指標，請兩兩比較其優先程度</p>
      <div id="pairs-B"></div>
    </section>

    <!-- C 文化永續 -->
    <section class="section" data-section="4">
      <span class="section-counter">第 4 部分，共 5 部分</span>
      <h2 class="section-header">文化永續（C）指標比較</h2>
      <p class="section-desc">共 10 項指標，請兩兩比較其優先程度</p>
      <div id="pairs-C"></div>
    </section>

    <!-- D 環境永續 -->
    <section class="section" data-section="5">
      <span class="section-counter">第 5 部分，共 5 部分</span>
      <h2 class="section-header">環境永續（D）指標比較</h2>
      <p class="section-desc">共 16 項指標，請兩兩比較其優先程度</p>
      <div id="pairs-D"></div>
    </section>

    <!-- 送出 -->
    <section class="section" data-section="6">
      <h2 class="section-header">問卷完成</h2>
      <p class="section-desc">感謝您完成所有題目！請按下方按鈕送出您的回答。</p>
      <div class="submit-section">
        <button id="btn-submit" class="btn-submit">結束送出</button>
        <p id="status" class="status"></p>
      </div>
    </section>
  </main>

  <!-- 進度條 -->
  <div class="progress-container">
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width:0%"></div>
    </div>
    <div class="progress-info">
      <span id="progress-text">已完成 0 題</span>
      <span id="progress-section" class="progress-section"></span>
    </div>
    <div class="nav-buttons">
      <button id="btn-prev" class="nav-btn" disabled>上一部分</button>
      <button id="btn-next" class="nav-btn primary">下一部分</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7DhIfZw71fq4YMKIwhTRzwFb_h9ZwtZ6_yyqmjbR44wJL9ezwNtqKiLBg6ZtpJ2Aq/exec";

    const scaleMarks = [-9,-7,-5,-3,-1,0,1,3,5,7,9];
    
    const sectionNames = [
      "基本資料",
      "構面比較",
      "永續管理 (A)",
      "社會經濟永續 (B)",
      "文化永續 (C)",
      "環境永續 (D)",
      "送出問卷"
    ];

    const items = {
      dimensions: [
        {id:"A", label:"永續管理"},
        {id:"B", label:"社會經濟永續"},
        {id:"C", label:"文化永續"},
        {id:"D", label:"環境永續"},
      ],
      A: [
        {id:"A1", label:"目的地管理責任分工與協調機制"},
        {id:"A2", label:"永續觀光策略與行動計畫"},
        {id:"A3", label:"永續績效監測與公開報告"},
        {id:"A4", label:"促進企業採行永續標準"},
        {id:"A5", label:"回應居民對觀光的意見"},
        {id:"A6", label:"回應遊客對旅遊體驗的意見"},
        {id:"A7", label:"提供正確透明的旅遊資訊"},
        {id:"A8", label:"遊客量與活動管理"},
        {id:"A9", label:"土地使用與開發管制"},
        {id:"A10", label:"氣候變遷風險調適"},
        {id:"A11", label:"風險與危機管理機制"},
        {id:"A12", label:"跨島交通與人流協調"},
        {id:"A13", label:"在地社區與利害關係人參與"},
        {id:"A14", label:"熱門海域活動許可與管理"},
      ],
      B: [
        {id:"B1", label:"衡量觀光對在地經濟貢獻"},
        {id:"B2", label:"合理的就業與職涯機會"},
        {id:"B3", label:"支持在地創業與公平交易"},
        {id:"B4", label:"觀光發展回饋社區"},
        {id:"B5", label:"避免剝削與不當對待"},
        {id:"B6", label:"保障居民財產與資源使用權"},
        {id:"B7", label:"旅遊安全與治安"},
        {id:"B8", label:"無障礙與全民可及性"},
        {id:"B9", label:"在地採購比例與來源可辨識"},
        {id:"B10", label:"降低旺季生活成本衝擊"},
        {id:"B11", label:"提升就業穩定與淡旺季分流"},
      ],
      C: [
        {id:"C1", label:"保護有形文化資產"},
        {id:"C2", label:"保存與展示文化文物"},
        {id:"C3", label:"傳承無形文化資產"},
        {id:"C4", label:"尊重傳統使用與進入權"},
        {id:"C5", label:"尊重在地文化智慧財產權"},
        {id:"C6", label:"文化場域遊客行為管理"},
        {id:"C7", label:"文化解說正確具教育性"},
        {id:"C8", label:"文化景觀與生活文化保護"},
        {id:"C9", label:"宗教祭典文化傳承"},
        {id:"C10", label:"具在地觀點的文化解說"},
      ],
      D: [
        {id:"D1", label:"保護敏感自然環境"},
        {id:"D2", label:"自然場域遊客行為管理"},
        {id:"D3", label:"規範遊客與野生動物互動"},
        {id:"D4", label:"避免物種不當利用"},
        {id:"D5", label:"節能與能源效率"},
        {id:"D6", label:"節水與水資源管理"},
        {id:"D7", label:"維持良好水質"},
        {id:"D8", label:"廢污水處理"},
        {id:"D9", label:"固體廢棄物減量與回收"},
        {id:"D10", label:"溫室氣體減量"},
        {id:"D11", label:"低衝擊運輸"},
        {id:"D12", label:"降低光害與噪音"},
        {id:"D13", label:"海漂垃圾管理與海灘清潔"},
        {id:"D14", label:"淡水供應與旺季用水管理"},
        {id:"D15", label:"潮間帶與珊瑚踏踩管制"},
        {id:"D16", label:"租賃運具與交通碳排管理"},
      ]
    };

    function makePairs(list){
      const pairs = [];
      for(let i=0;i<list.length;i++){
        for(let j=i+1;j<list.length;j++){
          pairs.push({left:list[i], right:list[j]});
        }
      }
      return pairs;
    }

    const pairs = {
      dimensions: makePairs(items.dimensions),
      A: makePairs(items.A),
      B: makePairs(items.B),
      C: makePairs(items.C),
      D: makePairs(items.D),
    };

    const answers = {};
    let totalPairs = 0;
    let answeredPairs = new Set();
    let currentSection = 0;
    const totalSections = 7;

    function keyOf(leftId, rightId){ return `${leftId}__${rightId}`; }

    function ratioFromV(v){
      if(v === 0) return 1;
      if(v > 0) return v;
      return 1 / Math.abs(v);
    }

    function formatValue(v){
      if(v === 0) return "同等優先";
      const absV = Math.abs(v);
      const desc = absV <= 1 ? "稍微" : absV <= 3 ? "略為" : absV <= 5 ? "明顯" : absV <= 7 ? "很" : "極為";
      return v < 0 ? `← ${desc}優先` : `${desc}優先 →`;
    }

    function updateProgress(){
      const pct = totalPairs > 0 ? Math.round((answeredPairs.size / totalPairs) * 100) : 0;
      document.getElementById("progress-fill").style.width = pct + "%";
      document.getElementById("progress-text").textContent = `已完成 ${answeredPairs.size} / ${totalPairs} 題`;
      document.getElementById("progress-section").textContent = sectionNames[currentSection];
    }

    function showSection(idx){
      currentSection = idx;
      document.querySelectorAll(".section").forEach((el, i) => {
        el.classList.toggle("active", i === idx);
      });
      
      const btnPrev = document.getElementById("btn-prev");
      const btnNext = document.getElementById("btn-next");
      
      btnPrev.disabled = idx === 0;
      
      if(idx === totalSections - 1){
        btnNext.style.display = "none";
      } else {
        btnNext.style.display = "";
        btnNext.textContent = idx === totalSections - 2 ? "前往送出" : "下一部分";
      }
      
      updateProgress();
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function renderPair(container, left, right){
      const key = keyOf(left.id, right.id);
      if(!(key in answers)) answers[key] = 0;

      const wrap = document.createElement("div");
      wrap.className = "pair";

      const question = document.createElement("div");
      question.className = "pair-question";
      question.textContent = `「${left.label}」vs「${right.label}」`;

      const options = document.createElement("div");
      options.className = "pair-options";

      const leftLabel = document.createElement("div");
      leftLabel.className = "pair-label left";
      leftLabel.textContent = left.label;

      const rightLabel = document.createElement("div");
      rightLabel.className = "pair-label right";
      rightLabel.textContent = right.label;

      const sliderWrap = document.createElement("div");
      sliderWrap.className = "slider-wrap";

      const range = document.createElement("input");
      range.type = "range";
      range.min = "-9";
      range.max = "9";
      range.step = "1";
      range.value = answers[key];

      const valueDisplay = document.createElement("div");
      valueDisplay.className = "slider-value";
      valueDisplay.textContent = formatValue(answers[key]);

      range.addEventListener("input", () => {
        const v = parseInt(range.value, 10);
        const snapped = scaleMarks.reduce((best, m) => Math.abs(m - v) < Math.abs(best - v) ? m : best, scaleMarks[0]);
        answers[key] = snapped;
        range.value = snapped;
        valueDisplay.textContent = formatValue(snapped);
        if(snapped !== 0) answeredPairs.add(key);
        updateProgress();
      });

      sliderWrap.appendChild(range);
      sliderWrap.appendChild(valueDisplay);

      options.appendChild(leftLabel);
      options.appendChild(sliderWrap);
      options.appendChild(rightLabel);

      wrap.appendChild(question);
      wrap.appendChild(options);
      container.appendChild(wrap);
    }

    function renderAll(){
      const sections = ["dimensions", "A", "B", "C", "D"];
      sections.forEach(sec => {
        const container = document.getElementById(`pairs-${sec}`);
        container.innerHTML = "";
        pairs[sec].forEach(p => {
          renderPair(container, p.left, p.right);
          totalPairs++;
        });
      });
      updateProgress();
    }

    function collect(){
      const meta = {
        name: document.getElementById("name").value || null,
        org: document.getElementById("org").value || null,
        field: document.getElementById("field").value || null,
        years: document.getElementById("years").value ? Number(document.getElementById("years").value) : null,
        exportedAt: new Date().toISOString()
      };

      const out = { meta, comparisons: { dimensions: [], A: [], B: [], C: [], D: [] } };

      function push(section, list){
        list.forEach(p => {
          const key = keyOf(p.left.id, p.right.id);
          const v = answers[key] ?? 0;
          out.comparisons[section].push({
            left: p.left.id,
            right: p.right.id,
            slider: v,
            ahp_ratio_aij: ratioFromV(v)
          });
        });
      }

      push("dimensions", pairs.dimensions);
      push("A", pairs.A);
      push("B", pairs.B);
      push("C", pairs.C);
      push("D", pairs.D);

      return out;
    }

    function setStatus(msg, cls){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = `status ${cls||""}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderAll();
      showSection(0);

      document.getElementById("btn-prev").addEventListener("click", () => {
        if(currentSection > 0) showSection(currentSection - 1);
      });
      
      document.getElementById("btn-next").addEventListener("click", () => {
        if(currentSection < totalSections - 1) showSection(currentSection + 1);
      });

      document.getElementById("btn-submit").addEventListener("click", async () => {
        if(!SCRIPT_URL){
          setStatus("系統錯誤：尚未設定後端網址", "warn");
          return;
        }
        
        const btn = document.getElementById("btn-submit");
        btn.disabled = true;
        btn.textContent = "送出中...";
        setStatus("正在送出，請稍候...", "");
        
        try{
          const data = collect();
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          const text = await res.text();
          let obj = null;
          try{ obj = JSON.parse(text); }catch(_e){}
          if(res.ok && obj && obj.ok){
            setStatus("✓ 送出成功！感謝您的填答。", "ok");
            btn.textContent = "已送出";
          }else{
            setStatus("送出失敗，請稍後再試或聯繫研究人員", "warn");
            btn.disabled = false;
            btn.textContent = "結束送出";
          }
        }catch(e){
          setStatus("網路錯誤，請檢查網路連線後再試", "warn");
          btn.disabled = false;
          btn.textContent = "結束送出";
        }
      });
    });
  </script>
</body>
</html>
